<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="enerkii Strompreisalarm - Erhalten Sie personalisierte Benachrichtigungen bei günstigen oder teuren Strompreisen">
  <title>enerkii Strompreisalarm</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.7/dist/Recharts.js"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f9fafb;
    }

    #enerkii-price-signal input:focus,
    #enerkii-price-signal select:focus {
      border-color: #1C754F;
      box-shadow: 0 0 0 2px rgba(28, 117, 79, 0.1);
    }

    #enerkii-price-signal button:hover:not(:disabled) {
      background-color: #155a3e !important;
    }

    * {
      box-sizing: border-box;
    }
  </style>
</head>
<body>

<div id="enerkii-price-signal"></div>

<script type="text/javascript">
(function() {
  'use strict';

  const { useState, useEffect } = React;
  const { XAxis, YAxis, ReferenceLine, Tooltip, ResponsiveContainer, Area, ComposedChart, Line } = Recharts;
  const e = React.createElement;

  // enerkii Brand Colors
  const colors = {
    primary: '#1C754F',
    primaryShade1: '#55977B',
    primaryShade2: '#8FBAA8',
    white: '#FFFFFF',
    lightGrey: '#FAFAFA',
    grey: '#A4A4A4',
    darkGrey: '#4E4E4E',
    black: '#222222',
    yellow: '#FEC240',
    lightYellow: '#FFE09F',
    blue: '#4E71EE'
  };

  // Fallback data generator
  const generateFallbackData = () => {
    const data = [];
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 180);

    for (let i = 0; i < 180; i++) {
      const date = new Date(startDate);
      date.setDate(date.getDate() + i);
      const basePrice = 50 + Math.sin(i / 30) * 20;
      const min = Math.round((basePrice - 20 - Math.random() * 30) * 100) / 100;
      const max = Math.round((basePrice + 40 + Math.random() * 50) * 100) / 100;
      const avg = Math.round(((min + max) / 2 + (Math.random() - 0.5) * 10) * 100) / 100;

      data.push({
        date: date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
        min: Math.max(-30, min),
        max: Math.min(180, max),
        avg: avg
      });
    }
    return data;
  };

  function EnerkiiPriceSignal() {
    const [formData, setFormData] = useState({
      vorname: '',
      name: '',
      geschlecht: '',
      unternehmen: '',
      email: '',
      telefon: '',
      upperThreshold: 80,
      lowerThreshold: 10
    });
    const [priceData, setPriceData] = useState([]);
    const [alerts, setAlerts] = useState({ above: 0, below: 0 });
    const [submitted, setSubmitted] = useState(false);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);
    const [isMobile, setIsMobile] = useState(window.innerWidth <= 768);

    useEffect(() => {
      const handleResize = () => {
        setIsMobile(window.innerWidth <= 768);
      };
      window.addEventListener('resize', handleResize);
      return () => window.removeEventListener('resize', handleResize);
    }, []);

    useEffect(() => {
      const fetchPrices = async () => {
        try {
          const response = await fetch('https://enerkii.app.n8n.cloud/webhook/webhook_get_price_history_day_ahead');
          if (!response.ok) throw new Error('API Error');
          const data = await response.json();

          const formatted = data.map(item => ({
            date: new Date(item.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
            min: parseFloat(item.min),
            max: parseFloat(item.max),
            avg: parseFloat(item.avg)
          }));

          setPriceData(formatted);
        } catch (error) {
          console.error('Fehler beim Laden, nutze Fallback:', error);
          setPriceData(generateFallbackData());
        } finally {
          setLoading(false);
        }
      };
      fetchPrices();
    }, []);

    useEffect(() => {
      if (priceData.length === 0) return;
      let daysAbove = 0;
      let daysBelow = 0;
      priceData.forEach(day => {
        if (day.max > formData.upperThreshold) daysAbove++;
        if (day.min < formData.lowerThreshold) daysBelow++;
      });
      setAlerts({ above: daysAbove, below: daysBelow });
    }, [formData.upperThreshold, formData.lowerThreshold, priceData]);

    const handleSubmit = async () => {
      // Input validation
      if (!formData.email || !formData.vorname || !formData.name) {
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
        return;
      }

      // Basic email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(formData.email)) {
        alert('Bitte geben Sie eine gültige E-Mail-Adresse ein.');
        return;
      }

      setSubmitting(true);
      try {
        const response = await fetch('https://enerkii.app.n8n.cloud/webhook/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vorname: formData.vorname,
            name: formData.name,
            geschlecht: formData.geschlecht,
            unternehmen: formData.unternehmen,
            mail: formData.email,
            telefon: formData.telefon,
            upper_price_signal: formData.upperThreshold,
            lower_price_signal: formData.lowerThreshold
          })
        });
        if (response.ok) {
          setSubmitted(true);
        } else {
          alert('Fehler beim Absenden. Bitte versuchen Sie es erneut.');
        }
      } catch (error) {
        console.error('Fehler:', error);
        alert('Verbindungsfehler. Bitte versuchen Sie es erneut.');
      } finally {
        setSubmitting(false);
      }
    };

    const inputStyle = {
      width: '100%',
      padding: '10px 12px',
      border: '1px solid #e5e7eb',
      borderRadius: '6px',
      fontSize: '14px',
      outline: 'none'
    };

    const labelStyle = {
      display: 'block',
      fontSize: '14px',
      marginBottom: '6px',
      color: colors.darkGrey
    };

    if (submitted) {
      return e('div', { style: { maxWidth: '800px', margin: '0 auto', padding: '24px' } },
        e('div', {
          style: {
            backgroundColor: 'white',
            borderRadius: '8px',
            border: '1px solid #e5e7eb',
            padding: '48px',
            textAlign: 'center'
          }
        },
          e('div', {
            style: {
              width: '64px',
              height: '64px',
              borderRadius: '50%',
              backgroundColor: colors.primaryShade2,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              margin: '0 auto 16px'
            }
          },
            e('svg', { width: 32, height: 32, fill: 'none', stroke: colors.primary, viewBox: '0 0 24 24' },
              e('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2.5, d: 'M5 13l4 4L19 7' })
            )
          ),
          e('h3', { style: { fontSize: '20px', fontWeight: '600', marginBottom: '8px', color: colors.black } },
            'Anmeldung erfolgreich!'
          ),
          e('p', { style: { color: colors.darkGrey } },
            'Sie erhalten ab morgen Ihre personalisierten Strompreis-Signale per E-Mail.'
          )
        )
      );
    }

    return e('div', { style: { maxWidth: '1000px', margin: '0 auto' } },
      e('div', {
        style: {
          backgroundColor: 'white',
          borderRadius: '8px',
          border: '1px solid #e5e7eb',
          overflow: 'hidden',
          display: 'grid',
          gridTemplateColumns: isMobile ? '1fr' : '1fr 1fr'
        }
      },

        // Left Side: Form
        e('div', { style: { padding: '24px', borderRight: isMobile ? 'none' : '1px solid #e5e7eb' } },
          e('h3', { style: { fontSize: '18px', fontWeight: '600', marginBottom: '20px', color: colors.black } },
            'Ihre Daten'
          ),

          // Name Row
          e('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' } },
            e('div', null,
              e('label', { style: labelStyle }, 'Vorname *'),
              e('input', {
                type: 'text',
                style: inputStyle,
                placeholder: 'Max',
                value: formData.vorname,
                onChange: (ev) => setFormData({...formData, vorname: ev.target.value})
              })
            ),
            e('div', null,
              e('label', { style: labelStyle }, 'Nachname *'),
              e('input', {
                type: 'text',
                style: inputStyle,
                placeholder: 'Mustermann',
                value: formData.name,
                onChange: (ev) => setFormData({...formData, name: ev.target.value})
              })
            )
          ),

          // Anrede
          e('div', { style: { marginBottom: '16px' } },
            e('label', { style: labelStyle }, 'Anrede'),
            e('select', {
              style: { ...inputStyle, backgroundColor: 'white' },
              value: formData.geschlecht,
              onChange: (ev) => setFormData({...formData, geschlecht: ev.target.value})
            },
              e('option', { value: '' }, 'Bitte wählen'),
              e('option', { value: 'Herr' }, 'Herr'),
              e('option', { value: 'Frau' }, 'Frau'),
              e('option', { value: 'Divers' }, 'Divers')
            )
          ),

          // Unternehmen
          e('div', { style: { marginBottom: '16px' } },
            e('label', { style: labelStyle }, 'Unternehmen'),
            e('input', {
              type: 'text',
              style: inputStyle,
              placeholder: 'Muster GmbH',
              value: formData.unternehmen,
              onChange: (ev) => setFormData({...formData, unternehmen: ev.target.value})
            })
          ),

          // Contact Row
          e('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '24px' } },
            e('div', null,
              e('label', { style: labelStyle }, 'E-Mail *'),
              e('input', {
                type: 'email',
                style: inputStyle,
                placeholder: 'max@muster.de',
                value: formData.email,
                onChange: (ev) => setFormData({...formData, email: ev.target.value})
              })
            ),
            e('div', null,
              e('label', { style: labelStyle }, 'Telefon'),
              e('input', {
                type: 'tel',
                style: inputStyle,
                placeholder: '+49 123 456789',
                value: formData.telefon,
                onChange: (ev) => setFormData({...formData, telefon: ev.target.value})
              })
            )
          ),

          // Threshold Section
          e('div', { style: { borderTop: '1px solid #e5e7eb', paddingTop: '20px' } },
            e('h4', { style: { fontSize: '14px', fontWeight: '600', marginBottom: '16px', color: colors.black } },
              'Preisschwellwerte'
            ),

            // Upper Threshold
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' } },
                e('span', { style: { fontSize: '14px', color: colors.darkGrey } }, 'Oberer Schwellwert'),
                e('span', { style: { fontSize: '14px', fontWeight: '600', color: colors.black } },
                  formData.upperThreshold + ' €/MWh',
                  e('span', { style: { fontWeight: '400', color: colors.grey, marginLeft: '4px' } },
                    '(' + (formData.upperThreshold / 10).toFixed(1) + ' ct/kWh)'
                  )
                )
              ),
              e('input', {
                type: 'range',
                min: 50,
                max: 200,
                step: 5,
                value: formData.upperThreshold,
                onChange: (ev) => setFormData({...formData, upperThreshold: parseInt(ev.target.value)}),
                style: {
                  width: '100%',
                  height: '8px',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  accentColor: colors.primary
                }
              })
            ),

            // Lower Threshold
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' } },
                e('span', { style: { fontSize: '14px', color: colors.darkGrey } }, 'Unterer Schwellwert'),
                e('span', { style: { fontSize: '14px', fontWeight: '600', color: colors.black } },
                  formData.lowerThreshold + ' €/MWh',
                  e('span', { style: { fontWeight: '400', color: colors.grey, marginLeft: '4px' } },
                    '(' + (formData.lowerThreshold / 10).toFixed(1) + ' ct/kWh)'
                  )
                )
              ),
              e('input', {
                type: 'range',
                min: -20,
                max: 50,
                step: 5,
                value: formData.lowerThreshold,
                onChange: (ev) => setFormData({...formData, lowerThreshold: parseInt(ev.target.value)}),
                style: {
                  width: '100%',
                  height: '8px',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  accentColor: colors.blue
                }
              })
            ),

            // Alert Stats
            e('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' } },
              e('div', {
                style: {
                  backgroundColor: colors.lightGrey,
                  borderRadius: '8px',
                  padding: '16px',
                  textAlign: 'center',
                  border: '2px solid ' + colors.primaryShade2
                }
              },
                e('div', { style: { fontSize: '28px', fontWeight: '700', color: colors.primary } }, alerts.above),
                e('div', { style: { fontSize: '12px', color: colors.darkGrey, marginTop: '4px' } }, 'Tage über Schwellwert')
              ),
              e('div', {
                style: {
                  backgroundColor: colors.lightGrey,
                  borderRadius: '8px',
                  padding: '16px',
                  textAlign: 'center',
                  border: '2px solid ' + colors.lightYellow
                }
              },
                e('div', { style: { fontSize: '28px', fontWeight: '700', color: colors.blue } }, alerts.below),
                e('div', { style: { fontSize: '12px', color: colors.darkGrey, marginTop: '4px' } }, 'Tage unter Schwellwert')
              )
            ),

            e('p', { style: { fontSize: '12px', color: colors.grey, textAlign: 'center', marginBottom: '16px' } },
              'Basierend auf den letzten ' + priceData.length + ' Tagen'
            )
          ),

          // Submit Button
          e('button', {
            onClick: handleSubmit,
            disabled: submitting,
            style: {
              width: '100%',
              padding: '14px',
              backgroundColor: submitting ? colors.primaryShade1 : colors.primary,
              color: 'white',
              border: 'none',
              borderRadius: '6px',
              fontSize: '16px',
              fontWeight: '600',
              cursor: submitting ? 'not-allowed' : 'pointer',
              transition: 'background-color 0.2s'
            }
          },
            submitting ? 'Wird gesendet...' : 'Kostenlos anmelden'
          )
        ),

        // Right Side: Chart
        !isMobile && e('div', { style: { padding: '24px', backgroundColor: colors.lightGrey } },
          e('div', { style: { marginBottom: '16px' } },
            e('h3', { style: { fontSize: '18px', fontWeight: '600', color: colors.black } },
              'Day-Ahead Strompreise'
            ),
            e('p', { style: { fontSize: '14px', color: colors.grey } },
              'Letzte ' + priceData.length + ' Tage · DE-LU Marktgebiet'
            )
          ),

          loading ?
            e('div', {
              style: {
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                height: '300px',
                backgroundColor: 'white',
                borderRadius: '8px',
                border: '1px solid #e5e7eb'
              }
            },
              e('div', { style: { textAlign: 'center' } },
                e('div', {
                  style: {
                    width: '40px',
                    height: '40px',
                    border: '3px solid ' + colors.primaryShade2,
                    borderTopColor: colors.primary,
                    borderRadius: '50%',
                    animation: 'spin 1s linear infinite',
                    margin: '0 auto 12px'
                  }
                }),
                e('p', { style: { fontSize: '14px', color: colors.grey } }, 'Lade Preisdaten...')
              )
            )
          :
            e('div', {
              style: {
                backgroundColor: 'white',
                borderRadius: '8px',
                padding: '16px',
                border: '1px solid #e5e7eb'
              }
            },
              e(ResponsiveContainer, { width: '100%', height: 320 },
                e(ComposedChart, { data: priceData, margin: { top: 20, right: 15, bottom: 10, left: -5 } },
                  e(XAxis, {
                    dataKey: 'date',
                    tick: { fontSize: 10, fill: colors.grey },
                    axisLine: { stroke: '#e5e7eb' },
                    tickLine: false,
                    interval: Math.floor(priceData.length / 6)
                  }),
                  e(YAxis, {
                    domain: [-50, 200],
                    tick: { fontSize: 10, fill: colors.grey },
                    axisLine: { stroke: '#e5e7eb' },
                    tickLine: false
                  }),
                  e(Tooltip, {
                    contentStyle: {
                      backgroundColor: 'white',
                      border: '1px solid ' + colors.primaryShade2,
                      borderRadius: '8px',
                      fontSize: '12px'
                    },
                    formatter: (value, name) => {
                      const labels = { max: 'Maximum', min: 'Minimum', avg: 'Durchschnitt' };
                      return [value.toFixed(2) + ' €/MWh', labels[name] || name];
                    },
                    labelFormatter: (label) => 'Datum: ' + label
                  }),
                  e(Area, {
                    type: 'monotone',
                    dataKey: 'max',
                    fill: colors.primaryShade2,
                    stroke: colors.primaryShade1,
                    strokeWidth: 1,
                    name: 'max',
                    fillOpacity: 0.4
                  }),
                  e(Area, {
                    type: 'monotone',
                    dataKey: 'min',
                    fill: colors.lightYellow,
                    stroke: colors.yellow,
                    strokeWidth: 1,
                    name: 'min',
                    fillOpacity: 0.5
                  }),
                  e(Line, {
                    type: 'monotone',
                    dataKey: 'avg',
                    stroke: colors.primary,
                    strokeWidth: 2,
                    dot: false,
                    name: 'avg'
                  }),
                  e(ReferenceLine, {
                    y: formData.upperThreshold,
                    stroke: colors.primary,
                    strokeDasharray: '6 4',
                    strokeWidth: 2
                  }),
                  e(ReferenceLine, {
                    y: formData.lowerThreshold,
                    stroke: colors.blue,
                    strokeDasharray: '6 4',
                    strokeWidth: 2
                  })
                )
              ),

              // Legend
              e('div', {
                style: {
                  display: 'flex',
                  justifyContent: 'center',
                  gap: '24px',
                  marginTop: '12px',
                  paddingTop: '12px',
                  borderTop: '1px solid #f3f4f6'
                }
              },
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } },
                  e('div', { style: { width: '12px', height: '12px', borderRadius: '50%', backgroundColor: colors.primary } }),
                  e('span', { style: { fontSize: '12px', color: colors.darkGrey } }, 'Durchschnitt')
                ),
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } },
                  e('div', { style: { width: '12px', height: '12px', borderRadius: '50%', backgroundColor: colors.primaryShade2 } }),
                  e('span', { style: { fontSize: '12px', color: colors.darkGrey } }, 'Maximum')
                ),
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '6px' } },
                  e('div', { style: { width: '12px', height: '12px', borderRadius: '50%', backgroundColor: colors.yellow } }),
                  e('span', { style: { fontSize: '12px', color: colors.darkGrey } }, 'Minimum')
                )
              )
            ),

          e('p', { style: { fontSize: '12px', color: colors.grey, textAlign: 'center', marginTop: '12px' } },
            'Bewegen Sie die Regler links, um zu sehen wie oft Sie benachrichtigt worden wären.'
          )
        )
      )
    );
  }

  ReactDOM.render(e(EnerkiiPriceSignal), document.getElementById('enerkii-price-signal'));
})();
</script>

</body>
</html>
