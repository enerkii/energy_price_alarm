<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="enerkii Strompreisalarm - Erhalten Sie personalisierte Benachrichtigungen bei günstigen oder teuren Strompreisen">
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://unpkg.com 'unsafe-inline'; connect-src 'self' https://enerkii.app.n8n.cloud;">
  <title>enerkii Strompreisalarm</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'enerkii-green': '#1C754F',
            'enerkii-green-mid': '#55977B',
            'enerkii-green-light': '#8FBAA8',
            'enerkii-grey': '#A4A4A4',
            'enerkii-grey-dark': '#4E4E4E',
            'enerkii-grey-light': '#FAFAFA',
            'enerkii-black': '#222222',
            'enerkii-yellow': '#FEC240',
            'enerkii-yellow-light': '#FFE09F',
            'enerkii-blue': '#4E71EE',
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loader {
      border: 3px solid #8FBAA8;
      border-top: 3px solid #1C754F;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
  </style>
</head>
<body class="bg-enerkii-grey-light">
  <div id="app"></div>

  <script>
    (function() {
      'use strict';

      // ============================================
      // MODULE 1: CONSTANTS & CONFIGURATION
      // ============================================

      const API_ENDPOINTS = {
        PRICE_HISTORY: 'https://enerkii.app.n8n.cloud/webhook/webhook_get_price_history_day_ahead',
        SIGNUP: 'https://enerkii.app.n8n.cloud/webhook/signup'
      };

      const VALIDATION_RULES = {
        vorname: {
          required: true,
          minLength: 2,
          message: 'Bitte geben Sie einen gültigen Vornamen ein (mind. 2 Zeichen)'
        },
        name: {
          required: true,
          minLength: 2,
          message: 'Bitte geben Sie einen gültigen Nachnamen ein (mind. 2 Zeichen)'
        },
        email: {
          required: true,
          pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
          message: 'Bitte geben Sie eine gültige E-Mail-Adresse ein'
        },
        telefon: {
          required: false,
          pattern: /^[\d\s+\-()]+$/,
          message: 'Bitte geben Sie eine gültige Telefonnummer ein'
        }
      };

      // ============================================
      // MODULE 2: STATE MANAGEMENT
      // ============================================

      const AppState = {
        priceData: [],
        formData: {
          vorname: '',
          name: '',
          geschlecht: '',
          unternehmen: '',
          email: '',
          telefon: '',
          upperThreshold: 120,
          lowerThreshold: 50
        },
        loading: true,
        submitting: false,
        submitted: false,
        alerts: { above: 0, below: 0 },
        isMobile: window.innerWidth <= 768
      };

      const StateManager = {
        listeners: [],

        updateState(updates) {
          Object.assign(AppState, updates);
          this.notify();
        },

        updateFormField(field, value) {
          AppState.formData[field] = value;
          this.notify();
        },

        subscribe(callback) {
          this.listeners.push(callback);
        },

        notify() {
          this.listeners.forEach(callback => callback(AppState));
        }
      };

      // ============================================
      // MODULE 3: DATA SERVICE
      // ============================================

      const DataService = {
        async fetchPriceData() {
          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 10000);

            const response = await fetch(API_ENDPOINTS.PRICE_HISTORY, {
              method: 'GET',
              headers: { 'Accept': 'application/json' },
              signal: controller.signal
            });

            clearTimeout(timeout);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            return this.transformPriceData(data);

          } catch (error) {
            console.error('Price data fetch failed, using fallback:', error);
            return this.generateFallbackData();
          }
        },

        transformPriceData(rawData) {
          return rawData.map(item => ({
            date: new Date(item.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
            dateObj: new Date(item.date),
            min: parseFloat(item.min),
            max: parseFloat(item.max),
            avg: parseFloat(item.avg)
          }));
        },

        generateFallbackData() {
          const data = [];
          const today = new Date();

          for (let i = 0; i < 180; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - (180 - i));

            const dayOfYear = Math.floor((date - new Date(date.getFullYear(), 0, 0)) / 86400000);
            const seasonalBase = 50 + Math.sin(dayOfYear / 365 * Math.PI * 2) * 20;
            const randomVariation = (Math.random() - 0.5) * 40;

            const basePrice = seasonalBase + randomVariation;

            // Allow negative prices and occasional very high prices
            const min = basePrice - 40 - Math.random() * 80; // Can go negative
            const max = basePrice + 60 + Math.random() * 100; // Can go much higher
            const avg = (min + max) / 2 + (Math.random() - 0.5) * 15;

            data.push({
              date: date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
              dateObj: date,
              min: parseFloat(min.toFixed(2)),
              max: parseFloat(max.toFixed(2)),
              avg: parseFloat(avg.toFixed(2))
            });
          }

          return data;
        },

        async submitSignup(formData) {
          try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);

            const response = await fetch(API_ENDPOINTS.SIGNUP, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                vorname: formData.vorname,
                name: formData.name,
                geschlecht: formData.geschlecht,
                unternehmen: formData.unternehmen,
                mail: formData.email,
                telefon: formData.telefon,
                upper_price_signal: formData.upperThreshold,
                lower_price_signal: formData.lowerThreshold
              }),
              signal: controller.signal
            });

            clearTimeout(timeout);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            return true;

          } catch (error) {
            console.error('Signup failed:', error);
            throw error;
          }
        }
      };

      // ============================================
      // MODULE 4: FORM VALIDATION
      // ============================================

      const FormValidator = {
        validate(formData) {
          const errors = {};

          Object.keys(VALIDATION_RULES).forEach(field => {
            const rule = VALIDATION_RULES[field];
            const value = formData[field];

            if (rule.required && (!value || value.trim() === '')) {
              errors[field] = rule.message;
              return;
            }

            if (value && rule.pattern && !rule.pattern.test(value)) {
              errors[field] = rule.message;
              return;
            }

            if (value && rule.minLength && value.length < rule.minLength) {
              errors[field] = rule.message;
            }
          });

          return errors;
        },

        showFieldError(fieldName, message) {
          const input = document.querySelector(`[name="${fieldName}"]`);
          if (!input) return;

          input.classList.add('border-red-500');

          let errorElement = input.nextElementSibling;
          if (!errorElement || !errorElement.classList.contains('error-message')) {
            errorElement = document.createElement('p');
            errorElement.className = 'error-message text-red-500 text-xs mt-1';
            input.parentNode.appendChild(errorElement);
          }
          errorElement.textContent = message;
        },

        clearFieldError(fieldName) {
          const input = document.querySelector(`[name="${fieldName}"]`);
          if (!input) return;

          input.classList.remove('border-red-500');

          const errorElement = input.nextElementSibling;
          if (errorElement && errorElement.classList.contains('error-message')) {
            errorElement.remove();
          }
        },

        clearAllErrors() {
          document.querySelectorAll('.error-message').forEach(el => el.remove());
          document.querySelectorAll('.border-red-500').forEach(el => {
            el.classList.remove('border-red-500');
          });
        }
      };

      // ============================================
      // MODULE 5: CHART MANAGER
      // ============================================

      let chartInstance = null;

      const ChartManager = {
        initialize(canvasId, priceData, thresholds) {
          const canvas = document.getElementById(canvasId);
          if (!canvas) return null;

          const ctx = canvas.getContext('2d');
          const isMobile = AppState.isMobile;

          // Use last 30 days on mobile, all data on desktop
          const displayData = isMobile ? priceData.slice(-30) : priceData;

          // Calculate dynamic Y-axis range based on actual data
          const allValues = displayData.flatMap(d => [d.min, d.max, d.avg]);
          const dataMin = Math.min(...allValues);
          const dataMax = Math.max(...allValues);

          // Add 10% padding to the range
          const range = dataMax - dataMin;
          const padding = range * 0.1;
          const yMin = Math.floor(dataMin - padding);
          const yMax = Math.ceil(dataMax + padding);

          chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: displayData.map(d => d.date),
              datasets: [
                {
                  label: 'Maximum',
                  data: displayData.map(d => d.max),
                  borderColor: '#55977B',
                  backgroundColor: 'rgba(143, 186, 168, 0.4)',
                  fill: true,
                  pointRadius: 0,
                  borderWidth: 1,
                  order: 3
                },
                {
                  label: 'Minimum',
                  data: displayData.map(d => d.min),
                  borderColor: '#FEC240',
                  backgroundColor: 'rgba(255, 224, 159, 0.5)',
                  fill: true,
                  pointRadius: 0,
                  borderWidth: 1,
                  order: 2
                },
                {
                  label: 'Durchschnitt',
                  data: displayData.map(d => d.avg),
                  borderColor: '#1C754F',
                  backgroundColor: 'transparent',
                  fill: false,
                  pointRadius: 0,
                  borderWidth: 2,
                  order: 1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: 'index',
                intersect: false
              },
              plugins: {
                tooltip: {
                  backgroundColor: '#FFFFFF',
                  borderColor: '#8FBAA8',
                  borderWidth: 1,
                  titleColor: '#222222',
                  bodyColor: '#4E4E4E',
                  padding: 12,
                  displayColors: true,
                  callbacks: {
                    label: function(context) {
                      const labels = {
                        'Maximum': 'Maximum',
                        'Minimum': 'Minimum',
                        'Durchschnitt': 'Durchschnitt'
                      };
                      return `${labels[context.dataset.label]}: ${context.parsed.y.toFixed(2)} €/MWh`;
                    }
                  }
                },
                legend: {
                  display: true,
                  position: 'bottom',
                  labels: {
                    usePointStyle: true,
                    pointStyle: 'circle',
                    color: '#4E4E4E',
                    font: { size: 12 },
                    padding: 15
                  }
                },
                annotation: {
                  annotations: {
                    upperThreshold: {
                      type: 'line',
                      yMin: thresholds.upper,
                      yMax: thresholds.upper,
                      borderColor: '#1C754F',
                      borderWidth: 2,
                      borderDash: [6, 4]
                    },
                    lowerThreshold: {
                      type: 'line',
                      yMin: thresholds.lower,
                      yMax: thresholds.lower,
                      borderColor: '#4E71EE',
                      borderWidth: 2,
                      borderDash: [6, 4]
                    }
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    color: '#A4A4A4',
                    font: { size: 10 },
                    maxRotation: 0,
                    autoSkip: true,
                    maxTicksLimit: isMobile ? 6 : 8
                  },
                  grid: { display: false }
                },
                y: {
                  min: yMin,
                  max: yMax,
                  ticks: {
                    color: '#A4A4A4',
                    font: { size: 10 },
                    callback: function(value) {
                      return value + ' €/MWh';
                    }
                  },
                  grid: { color: '#F3F4F6' }
                }
              }
            }
          });

          return chartInstance;
        },

        updateThresholds(upper, lower) {
          if (!chartInstance) return;

          chartInstance.options.plugins.annotation.annotations.upperThreshold.yMin = upper;
          chartInstance.options.plugins.annotation.annotations.upperThreshold.yMax = upper;
          chartInstance.options.plugins.annotation.annotations.lowerThreshold.yMin = lower;
          chartInstance.options.plugins.annotation.annotations.lowerThreshold.yMax = lower;

          chartInstance.update('none');
        },

        destroy() {
          if (chartInstance) {
            chartInstance.destroy();
            chartInstance = null;
          }
        }
      };

      // ============================================
      // MODULE 6: ALERT CALCULATOR
      // ============================================

      const AlertCalculator = {
        cachedAlerts: null,
        lastThresholds: { upper: null, lower: null },

        calculate(priceData, upperThreshold, lowerThreshold) {
          if (
            this.cachedAlerts &&
            this.lastThresholds.upper === upperThreshold &&
            this.lastThresholds.lower === lowerThreshold
          ) {
            return this.cachedAlerts;
          }

          let above = 0;
          let below = 0;

          priceData.forEach(day => {
            if (day.max > upperThreshold) above++;
            if (day.min < lowerThreshold) below++;
          });

          this.cachedAlerts = { above, below };
          this.lastThresholds = { upper: upperThreshold, lower: lowerThreshold };

          return this.cachedAlerts;
        }
      };

      // ============================================
      // MODULE 7: UI RENDERER
      // ============================================

      const UIRenderer = {
        renderLoadingView() {
          const app = document.getElementById('app');
          app.innerHTML = `
            <div class="flex items-center justify-center min-h-screen">
              <div class="text-center">
                <div class="loader mb-4"></div>
                <p class="text-enerkii-grey">Lade Preisdaten...</p>
              </div>
            </div>
          `;
        },

        renderMainView() {
          const app = document.getElementById('app');
          const isMobile = AppState.isMobile;

          app.innerHTML = `
            <div class="max-w-6xl mx-auto p-4 lg:p-6">
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 bg-white rounded-lg shadow-lg overflow-hidden">

                <!-- Form Column -->
                <div class="p-6 lg:border-r border-gray-200">
                  <h3 class="text-xl font-semibold text-enerkii-black mb-5">Ihre Daten</h3>

                  <!-- Name Row -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                      <label class="block text-sm text-enerkii-grey-dark mb-1">Vorname *</label>
                      <input type="text" name="vorname" placeholder="Max"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:border-transparent">
                    </div>
                    <div>
                      <label class="block text-sm text-enerkii-grey-dark mb-1">Nachname *</label>
                      <input type="text" name="name" placeholder="Mustermann"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:border-transparent">
                    </div>
                  </div>

                  <!-- Anrede -->
                  <div class="mb-4">
                    <label class="block text-sm text-enerkii-grey-dark mb-1">Anrede</label>
                    <select name="geschlecht"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:border-transparent bg-white">
                      <option value="">Bitte wählen</option>
                      <option value="Herr">Herr</option>
                      <option value="Frau">Frau</option>
                      <option value="Divers">Divers</option>
                    </select>
                  </div>

                  <!-- Unternehmen -->
                  <div class="mb-4">
                    <label class="block text-sm text-enerkii-grey-dark mb-1">Unternehmen</label>
                    <input type="text" name="unternehmen" placeholder="Muster GmbH"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:border-transparent">
                  </div>

                  <!-- Contact Row -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                      <label class="block text-sm text-enerkii-grey-dark mb-1">E-Mail *</label>
                      <input type="email" name="email" placeholder="max@muster.de"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:border-transparent">
                    </div>
                    <div>
                      <label class="block text-sm text-enerkii-grey-dark mb-1">Telefon</label>
                      <input type="tel" name="telefon" placeholder="+49 123 456789"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:border-transparent">
                    </div>
                  </div>

                  <!-- Threshold Section -->
                  <div class="border-t border-gray-200 pt-5">
                    <h4 class="text-sm font-semibold text-enerkii-black mb-4">Preisschwellwerte</h4>

                    <!-- Upper Threshold -->
                    <div class="mb-5">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-enerkii-grey-dark">Oberer Schwellwert</span>
                        <span class="text-sm font-semibold text-enerkii-black">
                          <span id="upper-value">120</span> €/MWh
                          <span class="font-normal text-enerkii-grey ml-1">(<span id="upper-value-kwh">12.0</span> ct/kWh)</span>
                        </span>
                      </div>
                      <input type="range" name="upperThreshold" id="upper-threshold"
                        min="120" max="800" step="10" value="120"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-enerkii-green">
                    </div>

                    <!-- Lower Threshold -->
                    <div class="mb-5">
                      <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-enerkii-grey-dark">Unterer Schwellwert</span>
                        <span class="text-sm font-semibold text-enerkii-black">
                          <span id="lower-value">50</span> €/MWh
                          <span class="font-normal text-enerkii-grey ml-1">(<span id="lower-value-kwh">5.0</span> ct/kWh)</span>
                        </span>
                      </div>
                      <input type="range" name="lowerThreshold" id="lower-threshold"
                        min="-150" max="50" step="10" value="50"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-enerkii-blue">
                    </div>

                    <!-- Alert Explanation -->
                    <div class="bg-enerkii-grey-light rounded-lg p-4 mb-4 space-y-3">
                      <p class="text-sm text-enerkii-grey-dark leading-relaxed">
                        In den letzten 6 Monaten wären Sie mit diesem Schwellwert
                        <span class="font-bold text-enerkii-green">an <span id="alert-above">0</span> Tagen für hohe Preise</span>
                        benachrichtigt worden.
                      </p>
                      <p class="text-sm text-enerkii-grey-dark leading-relaxed">
                        In den letzten 6 Monaten wären Sie mit diesem Schwellwert
                        <span class="font-bold text-enerkii-blue">an <span id="alert-below">0</span> Tagen für niedrige Preise</span>
                        benachrichtigt worden.
                      </p>
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <button id="submit-btn"
                    class="w-full py-3 bg-enerkii-green text-white font-semibold rounded-md hover:bg-enerkii-green-mid transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-enerkii-green focus:ring-offset-2">
                    Kostenlos anmelden
                  </button>
                </div>

                <!-- Chart Column -->
                <div class="p-6 bg-enerkii-grey-light">
                  <div class="mb-4">
                    <h3 class="text-lg font-semibold text-enerkii-black">Day-Ahead Strompreise</h3>
                    <p class="text-sm text-enerkii-grey">
                      Letzte <span id="chart-data-count">${isMobile ? '30' : '180'}</span> Tage · DE-LU Marktgebiet
                    </p>
                  </div>

                  <div class="bg-white rounded-lg p-4 border border-gray-200">
                    <canvas id="price-chart" style="height: ${isMobile ? '200px' : '320px'};"></canvas>
                  </div>

                  <p class="text-xs text-enerkii-grey text-center mt-3">
                    Bewegen Sie die Regler links, um zu sehen wie oft Sie benachrichtigt worden wären.
                  </p>
                </div>
              </div>
            </div>
          `;

          // Update data count elements
          const dataCountEl = document.getElementById('data-count');
          if (dataCountEl) dataCountEl.textContent = AppState.priceData.length;

          this.attachEventListeners();
          this.updateAlertStats();

          // Initialize chart
          setTimeout(() => {
            ChartManager.initialize('price-chart', AppState.priceData, {
              upper: AppState.formData.upperThreshold,
              lower: AppState.formData.lowerThreshold
            });
          }, 100);
        },

        renderSuccessView() {
          const app = document.getElementById('app');
          app.innerHTML = `
            <div class="flex items-center justify-center min-h-screen p-4">
              <div class="max-w-2xl w-full">
                <div class="bg-white rounded-lg shadow-lg p-12 text-center">
                  <div class="w-16 h-16 bg-enerkii-green-light rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-enerkii-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                  <h3 class="text-2xl font-semibold text-enerkii-black mb-2">
                    Anmeldung erfolgreich!
                  </h3>
                  <p class="text-enerkii-grey-dark">
                    Sie erhalten ab morgen Ihre personalisierten Strompreis-Signale per E-Mail.
                  </p>
                </div>
              </div>
            </div>
          `;
        },

        attachEventListeners() {
          // Form input listeners
          const formInputs = document.querySelectorAll('[name="vorname"], [name="name"], [name="geschlecht"], [name="unternehmen"], [name="email"], [name="telefon"]');
          formInputs.forEach(input => {
            input.addEventListener('input', (e) => {
              StateManager.updateFormField(e.target.name, e.target.value);
              FormValidator.clearFieldError(e.target.name);
            });
          });

          // Threshold slider listeners
          const upperSlider = document.getElementById('upper-threshold');
          const lowerSlider = document.getElementById('lower-threshold');

          if (upperSlider) {
            upperSlider.addEventListener('input', this.handleUpperThresholdChange.bind(this));
          }

          if (lowerSlider) {
            lowerSlider.addEventListener('input', this.handleLowerThresholdChange.bind(this));
          }

          // Submit button listener
          const submitBtn = document.getElementById('submit-btn');
          if (submitBtn) {
            submitBtn.addEventListener('click', this.handleSubmit.bind(this));
          }
        },

        handleUpperThresholdChange: debounce(function(e) {
          const value = parseInt(e.target.value);
          StateManager.updateFormField('upperThreshold', value);

          document.getElementById('upper-value').textContent = value;
          document.getElementById('upper-value-kwh').textContent = (value / 10).toFixed(1);

          ChartManager.updateThresholds(value, AppState.formData.lowerThreshold);
          this.updateAlertStats();
        }, 100),

        handleLowerThresholdChange: debounce(function(e) {
          const value = parseInt(e.target.value);
          StateManager.updateFormField('lowerThreshold', value);

          document.getElementById('lower-value').textContent = value;
          document.getElementById('lower-value-kwh').textContent = (value / 10).toFixed(1);

          ChartManager.updateThresholds(AppState.formData.upperThreshold, value);
          this.updateAlertStats();
        }, 100),

        updateAlertStats() {
          const alerts = AlertCalculator.calculate(
            AppState.priceData,
            AppState.formData.upperThreshold,
            AppState.formData.lowerThreshold
          );

          const aboveEl = document.getElementById('alert-above');
          const belowEl = document.getElementById('alert-below');

          if (aboveEl) aboveEl.textContent = alerts.above;
          if (belowEl) belowEl.textContent = alerts.below;
        },

        async handleSubmit() {
          FormValidator.clearAllErrors();

          const errors = FormValidator.validate(AppState.formData);

          if (Object.keys(errors).length > 0) {
            Object.entries(errors).forEach(([field, message]) => {
              FormValidator.showFieldError(field, message);
            });
            return;
          }

          const submitBtn = document.getElementById('submit-btn');
          if (!submitBtn) return;

          submitBtn.disabled = true;
          submitBtn.textContent = 'Wird gesendet...';
          submitBtn.classList.add('opacity-75', 'cursor-not-allowed');

          try {
            await DataService.submitSignup(AppState.formData);
            StateManager.updateState({ submitted: true });
            this.renderSuccessView();
          } catch (error) {
            alert('Es ist ein Fehler aufgetreten. Bitte versuchen Sie es später erneut.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Kostenlos anmelden';
            submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
          }
        }
      };

      // ============================================
      // MODULE 8: UTILITY FUNCTIONS
      // ============================================

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func.apply(this, args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // ============================================
      // MODULE 9: APPLICATION INITIALIZATION
      // ============================================

      async function initializeApp() {
        UIRenderer.renderLoadingView();

        try {
          const priceData = await DataService.fetchPriceData();
          StateManager.updateState({
            priceData,
            loading: false
          });

          UIRenderer.renderMainView();

        } catch (error) {
          console.error('App initialization failed:', error);
          document.getElementById('app').innerHTML = `
            <div class="flex items-center justify-center min-h-screen">
              <div class="text-center">
                <p class="text-red-500 mb-4">Fehler beim Laden der Anwendung</p>
                <p class="text-sm text-gray-600 mb-4">` + error.message + `</p>
                <button onclick="location.reload()"
                  class="px-4 py-2 bg-enerkii-green text-white rounded hover:bg-enerkii-green-mid">
                  Seite neu laden
                </button>
              </div>
            </div>
          `;
        }
      }

      // Resize handler
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const wasMobile = AppState.isMobile;
          AppState.isMobile = window.innerWidth <= 768;

          if (wasMobile !== AppState.isMobile && !AppState.submitted && !AppState.loading) {
            ChartManager.destroy();
            UIRenderer.renderMainView();
          }
        }, 250);
      });

      // Start app when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    })();
  </script>
</body>
</html>
