<!-- enerkii Strompreisalarm Component -->
<!-- Füge diesen Code in ein Webflow "Embed" Element ein -->

<div id="enerkii-price-signal"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
  const { useState, useEffect } = React;
  const { XAxis, YAxis, ReferenceLine, Tooltip, ResponsiveContainer, Area, ComposedChart, Line } = Recharts;

  // enerkii Brand Colors
  const colors = {
    primary: '#1C754F',
    primaryShade1: '#55977B',
    primaryShade2: '#8FBAA8',
    white: '#FFFFFF',
    lightGrey: '#FAFAFA',
    grey: '#A4A4A4',
    darkGrey: '#4E4E4E',
    black: '#222222',
    yellow: '#FEC240',
    lightYellow: '#FFE09F',
    blue: '#4E71EE'
  };

  // Fallback data generator
  const generateFallbackData = () => {
    const data = [];
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 180);
    
    for (let i = 0; i < 180; i++) {
      const date = new Date(startDate);
      date.setDate(date.getDate() + i);
      const basePrice = 50 + Math.sin(i / 30) * 20;
      const min = Math.round((basePrice - 20 - Math.random() * 30) * 100) / 100;
      const max = Math.round((basePrice + 40 + Math.random() * 50) * 100) / 100;
      const avg = Math.round(((min + max) / 2 + (Math.random() - 0.5) * 10) * 100) / 100;
      
      data.push({
        date: date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
        min: Math.max(-30, min),
        max: Math.min(180, max),
        avg: avg
      });
    }
    return data;
  };

  function EnerkiiPriceSignal() {
    const [formData, setFormData] = useState({
      vorname: '',
      name: '',
      geschlecht: '',
      unternehmen: '',
      email: '',
      telefon: '',
      upperThreshold: 80,
      lowerThreshold: 10
    });
    const [priceData, setPriceData] = useState([]);
    const [alerts, setAlerts] = useState({ above: 0, below: 0 });
    const [submitted, setSubmitted] = useState(false);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);

    useEffect(() => {
      const fetchPrices = async () => {
        try {
          const response = await fetch('https://enerkii.app.n8n.cloud/webhook/webhook_get_price_history_day_ahead');
          if (!response.ok) throw new Error('API Error');
          const data = await response.json();
          
          const formatted = data.map(item => ({
            date: new Date(item.date).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' }),
            min: parseFloat(item.min),
            max: parseFloat(item.max),
            avg: parseFloat(item.avg)
          }));
          
          setPriceData(formatted);
        } catch (error) {
          console.error('Fehler beim Laden, nutze Fallback:', error);
          setPriceData(generateFallbackData());
        } finally {
          setLoading(false);
        }
      };
      fetchPrices();
    }, []);

    useEffect(() => {
      if (priceData.length === 0) return;
      let daysAbove = 0;
      let daysBelow = 0;
      priceData.forEach(day => {
        if (day.max > formData.upperThreshold) daysAbove++;
        if (day.min < formData.lowerThreshold) daysBelow++;
      });
      setAlerts({ above: daysAbove, below: daysBelow });
    }, [formData.upperThreshold, formData.lowerThreshold, priceData]);

    const handleSubmit = async () => {
      if (!formData.email || !formData.vorname || !formData.name) {
        alert('Bitte füllen Sie alle Pflichtfelder aus.');
        return;
      }
      setSubmitting(true);
      try {
        const response = await fetch('https://enerkii.app.n8n.cloud/webhook/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            vorname: formData.vorname,
            name: formData.name,
            geschlecht: formData.geschlecht,
            unternehmen: formData.unternehmen,
            mail: formData.email,
            telefon: formData.telefon,
            upper_price_signal: formData.upperThreshold,
            lower_price_signal: formData.lowerThreshold
          })
        });
        if (response.ok) {
          setSubmitted(true);
        } else {
          alert('Fehler beim Absenden. Bitte versuchen Sie es erneut.');
        }
      } catch (error) {
        console.error('Fehler:', error);
        alert('Verbindungsfehler. Bitte versuchen Sie es erneut.');
      } finally {
        setSubmitting(false);
      }
    };

    const inputStyle = {
      width: '100%',
      padding: '10px 12px',
      border: '1px solid #e5e7eb',
      borderRadius: '6px',
      fontSize: '14px',
      outline: 'none',
      boxSizing: 'border-box'
    };

    const labelStyle = {
      display: 'block',
      fontSize: '14px',
      marginBottom: '6px',
      color: colors.darkGrey
    };

    if (submitted) {
      return (
        <div style={{ maxWidth: '800px', margin: '0 auto', padding: '24px' }}>
          <div style={{ 
            backgroundColor: 'white', 
            borderRadius: '8px', 
            border: '1px solid #e5e7eb',
            padding: '48px',
            textAlign: 'center'
          }}>
            <div style={{
              width: '64px',
              height: '64px',
              borderRadius: '50%',
              backgroundColor: colors.primaryShade2,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              margin: '0 auto 16px'
            }}>
              <svg width="32" height="32" fill="none" stroke={colors.primary} viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h3 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '8px', color: colors.black }}>
              Anmeldung erfolgreich!
            </h3>
            <p style={{ color: colors.darkGrey }}>
              Sie erhalten ab morgen Ihre personalisierten Strompreis-Signale per E-Mail.
            </p>
          </div>
        </div>
      );
    }

    return (
      <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
        <div style={{ 
          backgroundColor: 'white', 
          borderRadius: '8px', 
          border: '1px solid #e5e7eb',
          overflow: 'hidden',
          display: 'grid',
          gridTemplateColumns: window.innerWidth > 768 ? '1fr 1fr' : '1fr'
        }}>
          
          {/* Left Side: Form */}
          <div style={{ padding: '24px', borderRight: window.innerWidth > 768 ? '1px solid #e5e7eb' : 'none' }}>
            <h3 style={{ fontSize: '18px', fontWeight: '600', marginBottom: '20px', color: colors.black }}>
              Ihre Daten
            </h3>

            {/* Name Row */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
              <div>
                <label style={labelStyle}>Vorname *</label>
                <input
                  type="text"
                  style={inputStyle}
                  placeholder="Max"
                  value={formData.vorname}
                  onChange={(e) => setFormData({...formData, vorname: e.target.value})}
                />
              </div>
              <div>
                <label style={labelStyle}>Nachname *</label>
                <input
                  type="text"
                  style={inputStyle}
                  placeholder="Mustermann"
                  value={formData.name}
                  onChange={(e) => setFormData({...formData, name: e.target.value})}
                />
              </div>
            </div>

            {/* Anrede */}
            <div style={{ marginBottom: '16px' }}>
              <label style={labelStyle}>Anrede</label>
              <select
                style={{ ...inputStyle, backgroundColor: 'white' }}
                value={formData.geschlecht}
                onChange={(e) => setFormData({...formData, geschlecht: e.target.value})}
              >
                <option value="">Bitte wählen</option>
                <option value="Herr">Herr</option>
                <option value="Frau">Frau</option>
                <option value="Divers">Divers</option>
              </select>
            </div>

            {/* Unternehmen */}
            <div style={{ marginBottom: '16px' }}>
              <label style={labelStyle}>Unternehmen</label>
              <input
                type="text"
                style={inputStyle}
                placeholder="Muster GmbH"
                value={formData.unternehmen}
                onChange={(e) => setFormData({...formData, unternehmen: e.target.value})}
              />
            </div>

            {/* Contact Row */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '24px' }}>
              <div>
                <label style={labelStyle}>E-Mail *</label>
                <input
                  type="email"
                  style={inputStyle}
                  placeholder="max@muster.de"
                  value={formData.email}
                  onChange={(e) => setFormData({...formData, email: e.target.value})}
                />
              </div>
              <div>
                <label style={labelStyle}>Telefon</label>
                <input
                  type="tel"
                  style={inputStyle}
                  placeholder="+49 123 456789"
                  value={formData.telefon}
                  onChange={(e) => setFormData({...formData, telefon: e.target.value})}
                />
              </div>
            </div>

            {/* Threshold Section */}
            <div style={{ borderTop: '1px solid #e5e7eb', paddingTop: '20px' }}>
              <h4 style={{ fontSize: '14px', fontWeight: '600', marginBottom: '16px', color: colors.black }}>
                Preisschwellwerte
              </h4>

              {/* Upper Threshold */}
              <div style={{ marginBottom: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                  <span style={{ fontSize: '14px', color: colors.darkGrey }}>Oberer Schwellwert</span>
                  <span style={{ fontSize: '14px', fontWeight: '600', color: colors.black }}>
                    {formData.upperThreshold} €/MWh
                    <span style={{ fontWeight: '400', color: colors.grey, marginLeft: '4px' }}>
                      ({(formData.upperThreshold / 10).toFixed(1)} ct/kWh)
                    </span>
                  </span>
                </div>
                <input
                  type="range"
                  min="50"
                  max="200"
                  step="5"
                  value={formData.upperThreshold}
                  onChange={(e) => setFormData({...formData, upperThreshold: parseInt(e.target.value)})}
                  style={{ 
                    width: '100%', 
                    height: '8px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    accentColor: colors.primary
                  }}
                />
              </div>

              {/* Lower Threshold */}
              <div style={{ marginBottom: '20px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                  <span style={{ fontSize: '14px', color: colors.darkGrey }}>Unterer Schwellwert</span>
                  <span style={{ fontSize: '14px', fontWeight: '600', color: colors.black }}>
                    {formData.lowerThreshold} €/MWh
                    <span style={{ fontWeight: '400', color: colors.grey, marginLeft: '4px' }}>
                      ({(formData.lowerThreshold / 10).toFixed(1)} ct/kWh)
                    </span>
                  </span>
                </div>
                <input
                  type="range"
                  min="-20"
                  max="50"
                  step="5"
                  value={formData.lowerThreshold}
                  onChange={(e) => setFormData({...formData, lowerThreshold: parseInt(e.target.value)})}
                  style={{ 
                    width: '100%', 
                    height: '8px',
                    borderRadius: '4px',
                    cursor: 'pointer',
                    accentColor: colors.blue
                  }}
                />
              </div>

              {/* Alert Stats */}
              <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px', marginBottom: '16px' }}>
                <div style={{ 
                  backgroundColor: colors.lightGrey, 
                  borderRadius: '8px', 
                  padding: '16px', 
                  textAlign: 'center',
                  border: `2px solid ${colors.primaryShade2}`
                }}>
                  <div style={{ fontSize: '28px', fontWeight: '700', color: colors.primary }}>
                    {alerts.above}
                  </div>
                  <div style={{ fontSize: '12px', color: colors.darkGrey, marginTop: '4px' }}>
                    Tage über Schwellwert
                  </div>
                </div>
                <div style={{ 
                  backgroundColor: colors.lightGrey, 
                  borderRadius: '8px', 
                  padding: '16px', 
                  textAlign: 'center',
                  border: `2px solid ${colors.lightYellow}`
                }}>
                  <div style={{ fontSize: '28px', fontWeight: '700', color: colors.blue }}>
                    {alerts.below}
                  </div>
                  <div style={{ fontSize: '12px', color: colors.darkGrey, marginTop: '4px' }}>
                    Tage unter Schwellwert
                  </div>
                </div>
              </div>

              <p style={{ fontSize: '12px', color: colors.grey, textAlign: 'center', marginBottom: '16px' }}>
                Basierend auf den letzten {priceData.length} Tagen
              </p>
            </div>

            {/* Submit Button */}
            <button
              onClick={handleSubmit}
              disabled={submitting}
              style={{
                width: '100%',
                padding: '14px',
                backgroundColor: submitting ? colors.primaryShade1 : colors.primary,
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: submitting ? 'not-allowed' : 'pointer',
                transition: 'background-color 0.2s'
              }}
            >
              {submitting ? 'Wird gesendet...' : 'Kostenlos anmelden'}
            </button>
          </div>

          {/* Right Side: Chart */}
          {window.innerWidth > 768 && (
            <div style={{ padding: '24px', backgroundColor: colors.lightGrey }}>
              <div style={{ marginBottom: '16px' }}>
                <h3 style={{ fontSize: '18px', fontWeight: '600', color: colors.black }}>
                  Day-Ahead Strompreise
                </h3>
                <p style={{ fontSize: '14px', color: colors.grey }}>
                  Letzte {priceData.length} Tage · DE-LU Marktgebiet
                </p>
              </div>

              {loading ? (
                <div style={{ 
                  display: 'flex', 
                  alignItems: 'center', 
                  justifyContent: 'center', 
                  height: '300px',
                  backgroundColor: 'white',
                  borderRadius: '8px',
                  border: '1px solid #e5e7eb'
                }}>
                  <div style={{ textAlign: 'center' }}>
                    <div style={{ 
                      width: '40px', 
                      height: '40px', 
                      border: `3px solid ${colors.primaryShade2}`,
                      borderTopColor: colors.primary,
                      borderRadius: '50%',
                      animation: 'spin 1s linear infinite',
                      margin: '0 auto 12px'
                    }} />
                    <p style={{ fontSize: '14px', color: colors.grey }}>Lade Preisdaten...</p>
                  </div>
                </div>
              ) : (
                <div style={{ 
                  backgroundColor: 'white', 
                  borderRadius: '8px', 
                  padding: '16px',
                  border: '1px solid #e5e7eb'
                }}>
                  <ResponsiveContainer width="100%" height={320}>
                    <ComposedChart data={priceData} margin={{ top: 20, right: 15, bottom: 10, left: -5 }}>
                      <XAxis
                        dataKey="date"
                        tick={{ fontSize: 10, fill: colors.grey }}
                        axisLine={{ stroke: '#e5e7eb' }}
                        tickLine={false}
                        interval={Math.floor(priceData.length / 6)}
                      />
                      <YAxis
                        domain={[-50, 200]}
                        tick={{ fontSize: 10, fill: colors.grey }}
                        axisLine={{ stroke: '#e5e7eb' }}
                        tickLine={false}
                      />
                      <Tooltip
                        contentStyle={{
                          backgroundColor: 'white',
                          border: `1px solid ${colors.primaryShade2}`,
                          borderRadius: '8px',
                          fontSize: '12px'
                        }}
                        formatter={(value, name) => {
                          const labels = { max: 'Maximum', min: 'Minimum', avg: 'Durchschnitt' };
                          return [`${value.toFixed(2)} €/MWh`, labels[name] || name];
                        }}
                        labelFormatter={(label) => `Datum: ${label}`}
                      />
                      <Area
                        type="monotone"
                        dataKey="max"
                        fill={colors.primaryShade2}
                        stroke={colors.primaryShade1}
                        strokeWidth={1}
                        name="max"
                        fillOpacity={0.4}
                      />
                      <Area
                        type="monotone"
                        dataKey="min"
                        fill={colors.lightYellow}
                        stroke={colors.yellow}
                        strokeWidth={1}
                        name="min"
                        fillOpacity={0.5}
                      />
                      <Line
                        type="monotone"
                        dataKey="avg"
                        stroke={colors.primary}
                        strokeWidth={2}
                        dot={false}
                        name="avg"
                      />
                      <ReferenceLine
                        y={formData.upperThreshold}
                        stroke={colors.primary}
                        strokeDasharray="6 4"
                        strokeWidth={2}
                      />
                      <ReferenceLine
                        y={formData.lowerThreshold}
                        stroke={colors.blue}
                        strokeDasharray="6 4"
                        strokeWidth={2}
                      />
                    </ComposedChart>
                  </ResponsiveContainer>

                  {/* Legend */}
                  <div style={{ 
                    display: 'flex', 
                    justifyContent: 'center', 
                    gap: '24px', 
                    marginTop: '12px',
                    paddingTop: '12px',
                    borderTop: '1px solid #f3f4f6'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <div style={{ width: '12px', height: '12px', borderRadius: '50%', backgroundColor: colors.primary }}></div>
                      <span style={{ fontSize: '12px', color: colors.darkGrey }}>Durchschnitt</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <div style={{ width: '12px', height: '12px', borderRadius: '50%', backgroundColor: colors.primaryShade2 }}></div>
                      <span style={{ fontSize: '12px', color: colors.darkGrey }}>Maximum</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                      <div style={{ width: '12px', height: '12px', borderRadius: '50%', backgroundColor: colors.yellow }}></div>
                      <span style={{ fontSize: '12px', color: colors.darkGrey }}>Minimum</span>
                    </div>
                  </div>
                </div>
              )}

              <p style={{ fontSize: '12px', color: colors.grey, textAlign: 'center', marginTop: '12px' }}>
                Bewegen Sie die Regler links, um zu sehen wie oft Sie benachrichtigt worden wären.
              </p>
            </div>
          )}
        </div>
      </div>
    );
  }

  ReactDOM.render(<EnerkiiPriceSignal />, document.getElementById('enerkii-price-signal'));
</script>

<style>
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  #enerkii-price-signal input:focus,
  #enerkii-price-signal select:focus {
    border-color: #1C754F;
    box-shadow: 0 0 0 2px rgba(28, 117, 79, 0.1);
  }
  
  #enerkii-price-signal button:hover:not(:disabled) {
    background-color: #155a3e !important;
  }
</style>
